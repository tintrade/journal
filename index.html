<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal Entry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #f0f0f0;
            --container-bg: #ffffff;
            --text-color: #333;
            --secondary-text-color: #666;
            --border-color: #ddd;
            --header-border-color: #000;
            --button-bg: #3498db;
            --button-text-color: white;
            --button-hover-bg: #2980b9;
            --copy-btn-bg: #34495e;
            --copy-btn-hover-bg: #2c3e50;
            --action-btn-bg: #2ecc71;
            --action-btn-hover-bg: #27ae60;
            --delete-action-btn-bg: #e74c3c;
            --delete-action-btn-hover-bg: #c0392b;
            --switch-track-bg: #ccc;
            --checked-state-color: #2ecc71;
            --unchecked-state-color: #e74c3c;
            --neutral-btn-border: #ddd;
            --icon-color: #666;
            --delete-btn-color: #888;
            --delete-btn-hover-color: #555;
            --input-bg-color: #ffffff;
        }

        body.dark-mode {
            --bg-color: #2c3e50;
            --container-bg: #34495e;
            --text-color: #ecf0f1;
            --secondary-text-color: #bdc3c7;
            --border-color: #566573;
            --header-border-color: #ecf0f1;
            --button-bg: #3498db;
            --button-hover-bg: #2980b9;
            --copy-btn-bg: #1abc9c;
            --copy-btn-hover-bg: #16a085;
            --action-btn-bg: #1abc9c;
            --action-btn-hover-bg: #16a085;
            --delete-action-btn-bg: #e74c3c;
            --delete-action-btn-hover-bg: #c0392b;
            --switch-track-bg: #566573;
            --checked-state-color: #27ae60;
            --unchecked-state-color: #c0392b;
            --neutral-btn-border: #566573;
            --icon-color: #bdc3c7;
            --delete-btn-color: #95a5a6;
            --delete-btn-hover-color: #ecf0f1;
            --input-bg-color: #2c3e50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            padding: 20px;
            box-sizing: border-box;
            transition: background-color 0.3s;
        }

        .app-container {
            display: flex;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            align-items: flex-start;
        }
        
        .panel {
            background-color: var(--container-bg);
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            transition: background-color 0.3s;
        }
        
        .content-column {
            flex: 2;
        }

        .sidebar-column {
            flex: 1;
            position: sticky;
            top: 20px;
        }
        
        .sidebar-section {
            margin-bottom: 25px;
        }
        .sidebar-section:last-child {
            margin-bottom: 0;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--header-border-color);
            margin-bottom: 10px;
        }

        .title-text {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color);
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 25px;
        }

        .theme-switch input { opacity: 0; width: 0; height: 0; }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--switch-track-bg);
            transition: .4s;
            border-radius: 25px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 19px;
            width: 19px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(25px); }

        .checklist-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .checklist-item:last-child { border-bottom: none; }

        .item-text {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--text-color);
            outline: none;
            cursor: pointer;
            flex-grow: 1;
        }

        .three-state-button {
            display: flex;
            border-radius: 50px;
            border: 1px solid var(--neutral-btn-border);
            width: 60px;
            height: 25px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin-right: 10px;
        }

        .three-state-button .button-overlay {
            position: absolute;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: var(--container-bg);
            transition: background-color 0.3s;
        }

        .three-state-button.checked .button-overlay { background-color: var(--checked-state-color); }
        .three-state-button.unchecked .button-overlay { background-color: var(--unchecked-state-color); }

        .three-state-button .icon {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            font-weight: bold;
            color: var(--icon-color);
            z-index: 2;
        }
        
        .three-state-button[data-type="yn"].checked .icon-cross,
        .three-state-button[data-type="pn"].checked .icon-minus,
        .three-state-button[data-type="ls"].checked .icon-short { opacity: 0; }

        .three-state-button[data-type="yn"].unchecked .icon-check,
        .three-state-button[data-type="pn"].unchecked .icon-plus,
        .three-state-button[data-type="ls"].unchecked .icon-long { opacity: 0; }

        .three-state-button.checked .icon,
        .three-state-button.unchecked .icon { color: white; }
        
        .dropdown, .char-input, #comments-input, .money-input, .leverage-input, #template-name-input, #template-select {
            margin-right: 10px;
            height: 25px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 1em;
            cursor: pointer;
            outline: none;
            padding: 0 5px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            box-sizing: border-box;
        }

        .char-input, .leverage-input { text-align: center; }
        .char-input { width: 80px; }
        .leverage-input { width: 45px; }
        
        .money-input-container {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-right: 10px;
        }

        .money-input-container span { color: var(--text-color); font-weight: bold; }
        .money-input { text-align: right; margin-right: 0; }
        .money-input.dollars { width: 80px; }
        .money-input.cents { width: 35px; }

        .delete-btn {
            background: none;
            border: none;
            color: var(--delete-btn-color);
            font-size: 1.5em;
            cursor: pointer;
            transition: color 0.2s;
            padding: 0 5px;
            line-height: 1;
            height: 25px;
            display: flex;
            align-items: center;
        }
        .delete-btn:hover { color: var(--delete-btn-hover-color); }
        
        #summary-text {
            width: 100%; height: 150px; padding: 10px;
            border: 1px solid var(--border-color); border-radius: 5px;
            font-family: monospace; font-size: 1em; resize: vertical;
            background-color: var(--input-bg-color); color: var(--text-color);
            margin-top: 20px;
        }

        .summary-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .summary-actions button {
            flex: 1;
            padding: 10px;
            background-color: var(--copy-btn-bg);
            color: var(--button-text-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color: 0.2s;
        }
        .summary-actions button:hover { background-color: var(--copy-btn-hover-bg); }
        
        .comments-container { padding-top: 10px; }
        #comments-input {
            width: 100%; height: auto; font-family: inherit; padding: 8px;
            resize: vertical; margin-right: 0;
        }
        
        .sidebar-section h3 {
             margin: 0 0 10px 0;
            color: var(--text-color);
            font-size: 1.1em;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border-color);
        }

        .add-row-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .add-row-buttons button {
            padding: 10px; background-color: var(--button-bg); color: var(--button-text-color);
            border: none; border-radius: 5px; cursor: pointer; font-size: 1em; font-weight: bold;
            transition: background-color 0.2s;
        }
        .add-row-buttons button:hover { background-color: var(--button-hover-bg); }

        .template-row {
            display: flex;
            margin-bottom: 10px;
            gap: 10px;
        }
        .template-row input, .template-row select {
            flex: 1;
            margin-right: 0;
            height: 35px;
        }
        .template-row button, .template-row .file-upload-label {
            padding: 0 15px;
            height: 35px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: var(--button-text-color);
            background-color: var(--action-btn-bg);
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9em;
            text-align: center;
        }
        .template-row button:hover, .template-row .file-upload-label:hover { background-color: var(--action-btn-hover-bg); }
        #delete-template-btn { background-color: var(--delete-action-btn-bg); }
        #delete-template-btn:hover { background-color: var(--delete-action-btn-hover-bg); }
        #upload-template-input, #merge-txt-input, #merge-pdf-input { display: none; }
        .full-width-label {
            width: 100%;
        }

        @media (max-width: 900px) {
            .app-container { flex-direction: column; }
            .sidebar-column { position: static; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="content-column panel">
        <div id="capture-area">
            <div class="header">
                <span class="title-text">TRADING JOURNAL ENTRY</span>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="checklist-items">
                </div>
            <div class="comments-container">
                <textarea id="comments-input" placeholder="Comments..." maxlength="1000" rows="3"></textarea>
            </div>
        </div>
    </div>

    <div class="sidebar-column">
        <div class="panel sidebar-section">
            <h3>Summary & Actions</h3>
            <textarea id="summary-text" readonly></textarea>
            <div class="summary-actions">
                <button id="copy-btn">Copy!</button>
                <button id="download-txt-btn">Download as .txt</button>
                <button id="download-png-btn">Download as .png image</button>
            </div>
        </div>
        
        <div class="panel sidebar-section">
            <h3>Add Items</h3>
            <div class="add-row-buttons">
                <button id="add-yn-btn">Yes/No Item</button>
                <button id="add-dd-btn">Dropdown Item</button>
                <button id="add-pn-btn">-/+ Item</button>
                <button id="add-7char-btn">7 Char Item</button>
            </div>
        </div>

        <div class="panel sidebar-section">
            <h3>Template Management</h3>
            <div class="template-row">
                <input type="text" id="template-name-input" placeholder="Enter template name...">
                <button id="save-template-btn">Save</button>
            </div>
            <div class="template-row">
                <select id="template-select"></select>
                <button id="load-template-btn">Load</button>
                <button id="delete-template-btn">Delete</button>
            </div>
            <div class="template-row">
                <button id="download-template-btn">Download</button>
                <label for="upload-template-input" class="file-upload-label">Load from File</label>
                <input type="file" id="upload-template-input" accept=".json">
            </div>
            <div class="template-row">
                <label for="merge-txt-input" class="file-upload-label full-width-label">Merge multiple .txt files</label>
                <input type="file" id="merge-txt-input" accept=".txt" multiple>
            </div>
             <div class="template-row">
                <label for="merge-pdf-input" class="file-upload-label full-width-label">Merge multiple .txt files into a single pdf</label>
                <input type="file" id="merge-pdf-input" accept=".txt" multiple>
            </div>
        </div>
    </div>
</div>

<script>
    const defaultTemplate = [
        { text: "Macro Market", type: "pn", deletable: true }, { text: "News", type: "pn", deletable: true },
        { text: "Levels", type: "yn", deletable: true }, { text: "Trend", type: "yn", deletable: true },
        { text: "Volume/CVD", type: "yn", deletable: true }, { text: "Momentum", type: "yn", deletable: true },
        { text: "RSI", type: "7char", deletable: true }, { text: "Plan/Setup", type: "yn", deletable: true },
        { text: "Long/Short", type: "ls", deletable: false }, { text: "Margin in USD", type: "money", deletable: false },
        { text: "Leverage", type: "leverage", deletable: true }, { text: "Sleep quality", type: "dd", deletable: true },
        { text: "Mood", type: "dd", deletable: true }
    ];

    function validateNumericInput(input) {
        input.value = input.value.replace(/[^0-9]/g, '');
    }

    function handleButtonClick(event) {
        const button = event.currentTarget;
        const currentState = button.dataset.state;
        const rect = button.getBoundingClientRect();
        const clickX = event.clientX - rect.left;
        const middle = rect.width / 2;
        if (currentState === 'neutral') {
            if (clickX > middle) {
                button.classList.add('checked');
                button.dataset.state = 'checked';
            } else {
                button.classList.add('unchecked');
                button.dataset.state = 'unchecked';
            }
        } else {
            button.classList.remove('checked', 'unchecked');
            button.dataset.state = 'neutral';
        }
        updateSummaryText();
    }

    function handleDeleteClick(event) {
        if (confirm("Are you sure you want to delete this item?")) {
            event.currentTarget.closest('.checklist-item').remove();
            updateSummaryText();
        }
    }

    function createRow(itemData) {
        const { text, type, deletable } = itemData;
        const newItem = document.createElement('div');
        newItem.className = 'checklist-item';
        
        let controlHtml = '';
        switch(type) {
            case 'yn': controlHtml = `<div class="three-state-button" data-type="yn" data-state="neutral"><div class="icon icon-cross">×</div><div class="icon icon-check">✓</div><div class="button-overlay"></div></div>`; break;
            case 'pn': controlHtml = `<div class="three-state-button" data-type="pn" data-state="neutral"><div class="icon icon-minus">-</div><div class="icon icon-plus">+</div><div class="button-overlay"></div></div>`; break;
            case 'ls': controlHtml = `<div class="three-state-button" data-type="ls" data-state="neutral"><div class="icon icon-short">S</div><div class="icon icon-long">L</div><div class="button-overlay"></div></div>`; break;
            case 'dd': controlHtml = `<select class="dropdown" onchange="updateSummaryText()"><option value=""></option><option value="10">10</option><option value="9">9</option><option value="8">8</option><option value="7">7</option><option value="6">6</option><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option><option value="0">0</option><option value="-1">-1</option><option value="-2">-2</option><option value="-3">-3</option><option value="-4">-4</option><option value="-5">-5</option><option value="-6">-6</option><option value="-7">-7</option><option value="-8">-8</option><option value="-9">-9</option><option value="-10">-10</option></select>`; break;
            case '7char': controlHtml = `<input type="text" class="char-input" maxlength="7" oninput="updateSummaryText()">`; break;
            case 'money': controlHtml = `<div class="money-input-container"><input type="text" class="money-input dollars" placeholder="0" maxlength="7" oninput="validateNumericInput(this); updateSummaryText();"><span>,</span><input type="text" class="money-input cents" placeholder="00" maxlength="2" oninput="validateNumericInput(this); updateSummaryText();"></div>`; break;
            case 'leverage': controlHtml = `<input type="text" class="leverage-input" maxlength="3" oninput="validateNumericInput(this); updateSummaryText();">`; break;
        }

        const deleteButtonHtml = deletable ? `<button class="delete-btn">×</button>` : '';
        newItem.innerHTML = `<span class="item-text" contenteditable="true">${text}</span>${controlHtml}${deleteButtonHtml}`;
        document.getElementById('checklist-items').appendChild(newItem);

        const button = newItem.querySelector('.three-state-button');
        if (button) button.addEventListener('click', handleButtonClick);
        
        const deleteBtn = newItem.querySelector('.delete-btn');
        if (deleteBtn) deleteBtn.addEventListener('click', handleDeleteClick);
    }

    function buildChecklistFromStructure(structure) {
        document.getElementById('checklist-items').innerHTML = '';
        structure.forEach(itemData => createRow(itemData));
        updateSummaryText();
    }

    function getChecklistStructure() {
        const items = document.querySelectorAll('#checklist-items .checklist-item');
        const structure = [];
        items.forEach(item => {
            const text = item.querySelector('.item-text').textContent;
            let type = '';
            let deletable = !!item.querySelector('.delete-btn');
            
            const btn = item.querySelector('.three-state-button');
            const dropdown = item.querySelector('.dropdown');
            const charInput = item.querySelector('.char-input');
            const moneyContainer = item.querySelector('.money-input-container');
            const leverageInput = item.querySelector('.leverage-input');

            if (btn) type = btn.dataset.type;
            else if (dropdown) type = 'dd';
            else if (charInput) type = '7char';
            else if (moneyContainer) type = 'money';
            else if (leverageInput) type = 'leverage';
            
            structure.push({ text, type, deletable });
        });
        return structure;
    }

    function populateTemplateDropdown() {
        const select = document.getElementById('template-select');
        select.innerHTML = '';
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('checklist_template_')) {
                const name = key.replace('checklist_template_', '');
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            }
        }
        const activeTemplate = localStorage.getItem('active_template');
        if (activeTemplate) {
            select.value = activeTemplate;
        }
    }
    
    function saveTemplate() {
        const nameInput = document.getElementById('template-name-input');
        const name = nameInput.value.trim();
        if (!name) { alert('Please enter a name for the template.'); return; }
        const structure = getChecklistStructure();
        localStorage.setItem(`checklist_template_${name}`, JSON.stringify(structure));
        localStorage.setItem('active_template', name);
        nameInput.value = '';
        populateTemplateDropdown();
        alert(`Template "${name}" saved!`);
    }

    function loadTemplate() {
        const select = document.getElementById('template-select');
        const name = select.value;
        if (!name) { alert('No template selected.'); return; }
        const structureString = localStorage.getItem(`checklist_template_${name}`);
        if (structureString) {
            const structure = JSON.parse(structureString);
            buildChecklistFromStructure(structure);
            localStorage.setItem('active_template', name);
            alert(`Template "${name}" loaded!`);
        }
    }

    function deleteTemplate() {
        const select = document.getElementById('template-select');
        const name = select.value;
        if (!name) { alert('No template selected.'); return; }
        if (confirm(`Are you sure you want to delete the template "${name}"?`)) {
            localStorage.removeItem(`checklist_template_${name}`);
            if (localStorage.getItem('active_template') === name) {
                localStorage.removeItem('active_template');
            }
            populateTemplateDropdown();
            alert(`Template "${name}" deleted.`);
            buildChecklistFromStructure(defaultTemplate);
        }
    }

    function downloadTemplate() {
        const select = document.getElementById('template-select');
        const name = select.value;
        if (!name) { alert('No template selected to download.'); return; }
        const structureString = localStorage.getItem(`checklist_template_${name}`);
        const blob = new Blob([structureString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${name}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function uploadTemplate(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const structure = JSON.parse(e.target.result);
                let name = file.name.replace('.json', '');
                name = prompt('Enter a name for the imported template:', name);
                if (name) {
                    localStorage.setItem(`checklist_template_${name}`, JSON.stringify(structure));
                    localStorage.setItem('active_template', name);
                    buildChecklistFromStructure(structure);
                    populateTemplateDropdown();
                    alert(`Template "${name}" imported successfully!`);
                }
            } catch (error) { alert('Invalid template file.'); }
        };
        reader.readAsText(file);
        event.target.value = '';
    }
    
    function readFileAsText(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsText(file);
        });
    }

    async function mergeTxtFiles(event) {
        const files = event.target.files;
        if (!files.length) return;

        let allContent = [];
        for (const file of files) {
            try {
                const text = await readFileAsText(file);
                allContent.push(`====================\nFILE: ${file.name}\n====================\n\n${text}`);
            } catch (err) {
                console.error("Error reading file:", file.name, err);
                alert(`Could not read the file: ${file.name}`);
            }
        }

        const separator = `\n\n\n`;
        const mergedContent = allContent.join(separator);
        const blob = new Blob([mergedContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'Merged_Files.txt';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        event.target.value = '';
    }

    async function mergeTxtFilesAsPdf(event) {
        const files = event.target.files;
        if (!files.length) return;

        const label = document.querySelector('label[for="merge-pdf-input"]');
        const originalText = label.textContent;
        label.textContent = 'Generating PDF...';

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const margin = 15;
            const maxWidth = doc.internal.pageSize.getWidth() - margin * 2;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const text = await readFileAsText(file);
                if (i > 0) { doc.addPage(); }
                let y = margin;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`File: ${file.name}`, margin, y);
                y += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const textLines = doc.splitTextToSize(text, maxWidth);
                doc.text(textLines, margin, y);
            }
            doc.save('Merged_Files.pdf');
        } catch (err) {
            console.error("Error generating PDF:", err);
            alert("Could not generate PDF. See console for details.");
        } finally {
            label.textContent = originalText;
            event.target.value = '';
        }
    }
    
    function getFilenameTimestamp() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        const minute = String(now.getMinutes()).padStart(2, '0');
        const second = String(now.getSeconds()).padStart(2, '0');
        return `${year}.${month}.${day} ${hour}-${minute}-${second}`;
    }

    function generateEntryText() {
        const listContent = document.getElementById('summary-text').value;
        const commentsText = document.getElementById('comments-input').value.trim();
        const now = new Date();
        const contentTimestamp = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
        
        const headerLines = [
            "Trade No:", `Position opening: ${contentTimestamp}`, "Position closing:",
            "Profit amount in USD:", "Margin-based profit percentage:", "Loss amount in USD:", "Margin-based loss percentage:"
        ];
        let finalContentArray = [...headerLines];
        if (listContent.trim()) {
            finalContentArray.push('');
            finalContentArray.push(listContent.trim());
        }
        finalContentArray.push('');
        finalContentArray.push('Comments:');
        if (commentsText) { finalContentArray.push(commentsText); }
        return finalContentArray.join('\n');
    }

    function copyToClipboard() {
        const fullContent = generateEntryText();
        navigator.clipboard.writeText(fullContent);
        alert("Text copied to clipboard!");
    }

    function downloadEntryAsTxt() {
        const fullContent = generateEntryText();
        const filenameTimestamp = getFilenameTimestamp();
        const activeTemplateName = localStorage.getItem('active_template');
        let filename = `Trade ${filenameTimestamp}.txt`;
        if (activeTemplateName) {
            filename = `${activeTemplateName} - Trade ${filenameTimestamp}.txt`;
        }
        const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function downloadEntryAsPng() {
        const button = document.getElementById('download-png-btn');
        const elementToCapture = document.getElementById('capture-area');
        const filenameTimestamp = getFilenameTimestamp();
        const activeTemplateName = localStorage.getItem('active_template');
        let filename = `Trade ${filenameTimestamp}.png`;
        if (activeTemplateName) {
            filename = `${activeTemplateName} - Trade ${filenameTimestamp}.png`;
        }

        button.textContent = 'Generating...';
        button.disabled = true;

        try {
            const canvas = await html2canvas(elementToCapture, {
                useCORS: true,
                backgroundColor: getComputedStyle(document.body).getPropertyValue('--bg-color')
            });
            const dataUrl = canvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (error) {
            console.error('Error generating image:', error);
            alert('Could not generate image. See console for details.');
        } finally {
            button.textContent = 'Download as .png image';
            button.disabled = false;
        }
    }

    function updateSummaryText() {
        const summaryTextarea = document.getElementById('summary-text');
        const listItems = document.querySelectorAll('.checklist-item');
        let summaryContent = "";
        listItems.forEach(item => {
            const text = item.querySelector('.item-text').textContent;
            let value = "";
            const itemButton = item.querySelector('.three-state-button');
            const dropdown = item.querySelector('.dropdown');
            const charInput = item.querySelector('.char-input');
            const dollarsInput = item.querySelector('.money-input.dollars');
            const centsInput = item.querySelector('.money-input.cents');
            const leverageInput = item.querySelector('.leverage-input');
            if (itemButton && itemButton.dataset.type === 'yn') {
                const state = itemButton.dataset.state;
                if (state === 'checked') { value = "Yes"; } else if (state === 'unchecked') { value = "No"; }
            } else if (itemButton && itemButton.dataset.type === 'ls') {
                const state = itemButton.dataset.state;
                if (state === 'checked') { value = "Long"; } else if (state === 'unchecked') { value = "Short"; }
            } else if (dropdown) {
                value = dropdown.value;
            } else if (itemButton && itemButton.dataset.type === 'pn') {
                const state = itemButton.dataset.state;
                if (state === 'checked') { value = "+"; } else if (state === 'unchecked') { value = "-"; }
            } else if (charInput) {
                value = charInput.value;
            } else if (dollarsInput && centsInput) {
                if (dollarsInput.value || centsInput.value) {
                    const dollars = dollarsInput.value || '0';
                    const cents = centsInput.value.padStart(2, '0');
                    const formattedDollars = Number(dollars).toLocaleString('en-US');
                    value = `${formattedDollars}.${cents} USD`;
                }
            } else if (leverageInput) {
                value = leverageInput.value;
            }
            summaryContent += `${text}: ${value}\n`;
        });
        summaryTextarea.value = summaryContent;
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Theme switcher
        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        themeToggle.addEventListener('change', () => {
            body.classList.toggle('dark-mode');
            localStorage.setItem('theme', body.classList.contains('dark-mode') ? 'dark' : 'light');
        });
        if (localStorage.getItem('theme') === 'dark') {
            body.classList.add('dark-mode');
            themeToggle.checked = true;
        }

        // Initial checklist load
        const activeTemplateName = localStorage.getItem('active_template');
        let initialStructure = defaultTemplate;
        if (activeTemplateName) {
            const savedStructure = localStorage.getItem(`checklist_template_${activeTemplateName}`);
            if (savedStructure) {
                initialStructure = JSON.parse(savedStructure);
            }
        }
        buildChecklistFromStructure(initialStructure);
        
        populateTemplateDropdown();

        // Add row buttons
        document.getElementById('add-yn-btn').addEventListener('click', () => createRow({ text: 'New Yes/No Item', type: 'yn', deletable: true }));
        document.getElementById('add-dd-btn').addEventListener('click', () => createRow({ text: 'New Dropdown Item', type: 'dd', deletable: true }));
        document.getElementById('add-pn-btn').addEventListener('click', () => createRow({ text: 'New +/- Item', type: 'pn', deletable: true }));
        document.getElementById('add-7char-btn').addEventListener('click', () => createRow({ text: 'New 7 Char Item', type: '7char', deletable: true }));

        // Template management buttons
        document.getElementById('save-template-btn').addEventListener('click', saveTemplate);
        document.getElementById('load-template-btn').addEventListener('click', loadTemplate);
        document.getElementById('delete-template-btn').addEventListener('click', deleteTemplate);
        document.getElementById('download-template-btn').addEventListener('click', downloadTemplate);
        document.getElementById('upload-template-input').addEventListener('change', uploadTemplate);
        document.getElementById('merge-txt-input').addEventListener('change', mergeTxtFiles);
        document.getElementById('merge-pdf-input').addEventListener('change', mergeTxtFilesAsPdf);

        // Summary action buttons
        document.getElementById('copy-btn').addEventListener('click', copyToClipboard);
        document.getElementById('download-txt-btn').addEventListener('click', downloadEntryAsTxt);
        document.getElementById('download-png-btn').addEventListener('click', downloadEntryAsPng);
        
        updateSummaryText();
    });
</script>

</body>
</html>